{"uid":"f6b2d17be5449edf","name":"test_encrypt_with_mka_multiple_devices","historyId":"pytest:macsec.test_macsec_mka_multiple_devices#test_encrypt_with_mka_multiple_devices","time":{"start":1756112750540,"stop":1756112868477,"duration":117937},"status":"failed","statusMessage":"assert 2 == 1\n +  where 2 = len(<snappi.snappi.MacsecMetricIter object at 0x7f7de64dc6c0>)\n +    where <snappi.snappi.MacsecMetricIter object at 0x7f7de64dc6c0> = <snappi.snappi.MetricsResponse object at 0x7f7de6397e20>.macsec_metrics","statusTrace":"api = <snappi_ixnetwork.snappi_api.Api object at 0x7f7de9512770>\nb2b_raw_config = <snappi.snappi.Config object at 0x7f7de55eb330>\nutils = <module 'utils' from '/home/github-runner/actions-runner/_work/snappi-ixnetwork/snappi-ixnetwork/tests/utils/__init__.py'>\n\n    def test_encrypt_with_mka_multiple_devices(api, b2b_raw_config, utils):\n        \"\"\"\n        Test for the macsec configuration\n        \"\"\"\n        config = b2b_raw_config\n        api.set_config(api.config())\n        config.flows.clear()\n        #ixnetwork = api._ixnetwork\n    \n        p1, p2 = config.ports\n        d1, d2, d3, d4 = config.devices.device(name=\"enc_only_macsec1\").device(name=\"enc_only_macsec2\").device(name=\"enc_only_macsec3\").device(name=\"enc_only_macsec4\")\n    \n        eth1, eth2 = d1.ethernets.add(), d2.ethernets.add()\n        eth3, eth4 = d3.ethernets.add(), d4.ethernets.add()\n    \n        eth1.connection.port_name, eth2.connection.port_name = p1.name, p2.name\n        eth3.connection.port_name, eth4.connection.port_name = p1.name, p2.name\n    \n        eth1.mac, eth2.mac = \"00:00:11:00:00:01\", \"00:00:22:00:00:02\"\n        eth3.mac, eth4.mac = \"00:00:33:00:00:01\", \"00:00:44:00:00:02\"\n    \n        ip1, ip2 = eth1.ipv4_addresses.add(), eth2.ipv4_addresses.add()\n        ip3, ip4 = eth3.ipv4_addresses.add(), eth4.ipv4_addresses.add()\n    \n        eth1.name, eth2.name = \"eth1\", \"eth2\"\n        eth3.name, eth4.name = \"eth3\", \"eth4\"\n    \n        ip1.name, ip2.name = \"ip1\", \"ip2\"\n        ip3.name, ip4.name = \"ip3\", \"ip4\"\n    \n        ####################\n        # MACsec\n        ####################\n        macsec1, macsec2 = d1.macsec, d2.macsec\n        macsec3, macsec4 = d3.macsec, d4.macsec\n    \n        macsec1_int, macsec2_int = macsec1.ethernet_interfaces.add(), macsec2.ethernet_interfaces.add()\n        macsec3_int, macsec4_int = macsec3.ethernet_interfaces.add(), macsec4.ethernet_interfaces.add()\n    \n        macsec1_int.eth_name, macsec2_int.eth_name = eth1.name, eth2.name\n        macsec3_int.eth_name, macsec4_int.eth_name = eth3.name, eth4.name\n    \n        secy1, secy2 = macsec1_int.secure_entity, macsec2_int.secure_entity\n        secy3, secy4 = macsec3_int.secure_entity, macsec4_int.secure_entity\n    \n        secy1.name, secy2.name = \"macsec1\", \"macsec2\"\n        secy3.name, secy4.name = \"macsec3\", \"macsec4\"\n    \n        # Data plane and crypto engine\n        secy1.data_plane.choice = secy2.data_plane.choice = \"encapsulation\"\n        secy3.data_plane.choice = secy4.data_plane.choice = \"encapsulation\"\n    \n        secy1.data_plane.encapsulation.crypto_engine.choice = secy2.data_plane.encapsulation.crypto_engine.choice = \"encrypt_only\"\n        secy3.data_plane.encapsulation.crypto_engine.choice = secy4.data_plane.encapsulation.crypto_engine.choice = \"encrypt_only\"\n    \n        # Data plane and crypto engine\n        secy1_crypto_engine_enc_only, secy2_crypto_engine_enc_only = secy1.data_plane.encapsulation.crypto_engine.encrypt_only, secy2.data_plane.encapsulation.crypto_engine.encrypt_only\n        secy3_crypto_engine_enc_only, secy4_crypto_engine_enc_only = secy3.data_plane.encapsulation.crypto_engine.encrypt_only, secy4.data_plane.encapsulation.crypto_engine.encrypt_only\n    \n        # Data plane Tx SC\n        secy1_dataplane_txsc1, secy2_dataplane_txsc1 = secy1_crypto_engine_enc_only.secure_channels.add(), secy2_crypto_engine_enc_only.secure_channels.add()\n        secy3_dataplane_txsc1, secy4_dataplane_txsc1 = secy3_crypto_engine_enc_only.secure_channels.add(), secy4_crypto_engine_enc_only.secure_channels.add()\n    \n        # Fixed PN\n        secy1_dataplane_txsc1.tx_pn.choice = secy2_dataplane_txsc1.tx_pn.choice = \"fixed_pn\"\n        secy3_dataplane_txsc1.tx_pn.choice = secy4_dataplane_txsc1.tx_pn.choice = \"fixed_pn\"\n    \n        ####################\n        # MKA\n        ####################\n        secy1_key_gen_proto, secy2_key_gen_proto = secy1.key_generation_protocol, secy2.key_generation_protocol\n        secy3_key_gen_proto, secy4_key_gen_proto = secy3.key_generation_protocol, secy4.key_generation_protocol\n    \n        secy1_key_gen_proto.choice = secy2_key_gen_proto.choice = \"mka\"\n        secy3_key_gen_proto.choice = secy4_key_gen_proto.choice = \"mka\"\n    \n        kay1, kay2 = secy1_key_gen_proto.mka, secy2_key_gen_proto.mka\n        kay3, kay4 = secy3_key_gen_proto.mka, secy4_key_gen_proto.mka\n    \n        kay1.name, kay2.name = \"mka1\", \"mka2\"\n        kay3.name, kay4.name = \"mka3\", \"mka4\"\n    \n        # Basic properties\n        kay1.basic.key_derivation_function = kay2.basic.key_derivation_function = \"aes_cmac_128\"\n        kay3.basic.key_derivation_function = kay4.basic.key_derivation_function = \"aes_cmac_128\"\n    \n        # Key source: PSK\n        kay1_key_src, kay2_key_src = kay1.basic.key_source, kay2.basic.key_source\n        kay3_key_src, kay4_key_src = kay3.basic.key_source, kay4.basic.key_source\n    \n        kay1_key_src.choice = kay2_key_src.choice = \"psk\"\n        kay3_key_src.choice = kay4_key_src.choice = \"psk\"\n    \n        kay1_psk_chain, kay2_psk_chain = kay1_key_src.psks, kay2_key_src.psks\n        kay3_psk_chain, kay4_psk_chain = kay3_key_src.psks, kay4_key_src.psks\n    \n        # PSK 1\n        kay1_psk1, kay2_psk1 = kay1_psk_chain.add(), kay2_psk_chain.add()\n        kay3_psk1, kay4_psk1 = kay3_psk_chain.add(), kay4_psk_chain.add()\n    \n        kay1_psk1.cak_name = kay2_psk1.cak_name = kay3_psk1.cak_name = kay4_psk1.cak_name = \"0xF123456789ABCDEF0123456789ABCDEFF123456789ABCDEF0123456789ABCD01\"\n        kay1_psk1.cak_value = kay2_psk1.cak_value = kay3_psk1.cak_value = kay4_psk1.cak_value = \"0xF123456789ABCDEF0123456789ABCD01\"\n    \n        kay1_psk1.start_offset_time.hh = kay2_psk1.start_offset_time.hh = kay3_psk1.start_offset_time.hh = kay4_psk1.start_offset_time.hh = 0\n        kay1_psk1.start_offset_time.mm = kay2_psk1.start_offset_time.mm = kay3_psk1.start_offset_time.mm = kay4_psk1.start_offset_time.mm = 0\n    \n        kay1_psk1.end_offset_time.hh = kay2_psk1.end_offset_time.hh = kay3_psk1.end_offset_time.hh = kay4_psk1.end_offset_time.hh = 0\n        kay1_psk1.end_offset_time.hh = kay2_psk1.end_offset_time.hh = kay3_psk1.end_offset_time.hh = kay4_psk1.end_offset_time.hh = 0\n    \n        # Rekey mode\n        kay1_rekey_mode, kay2_rekey_mode, kay3_rekey_mode, kay4_rekey_mode = kay1.basic.rekey_mode, kay2.basic.rekey_mode, kay3.basic.rekey_mode, kay4.basic.rekey_mode\n        kay1_rekey_mode.choice = kay2_rekey_mode.choice = kay3_rekey_mode.choice = kay4_rekey_mode.choice = \"dont_rekey\"\n    \n        # Remaining basic properties autofilled\n    \n        # Key server\n        kay1_key_server, kay2_key_server, kay3_key_server, kay4_key_server = kay1.key_server, kay2.key_server, kay3.key_server, kay4.key_server\n        kay1_key_server.cipher_suite = kay2_key_server.cipher_suite = kay3_key_server.cipher_suite = kay4_key_server.cipher_suite = \"gcm_aes_128\"\n    \n        # Tx SC\n        kay1_tx, kay2_tx, kay3_tx, kay4_tx = kay1.tx, kay2.tx, kay3.tx, kay4.tx\n        kay1_txsc1, kay2_txsc1, kay3_txsc1, kay4_txsc1 = kay1_tx.secure_channels.add(), kay2_tx.secure_channels.add(), kay3_tx.secure_channels.add(), kay4_tx.secure_channels.add()\n    \n        kay1_txsc1.name, kay2_txsc1.name, kay3_txsc1.name, kay4_txsc1.name = \"txsc1\", \"txsc2\", \"txsc3\", \"txsc4\"\n        kay1_txsc1.system_id, kay2_txsc1.system_id, kay3_txsc1.system_id, kay4_txsc1.system_id = eth1.mac, eth2.mac, eth3.mac, eth4.mac\n        # Remaining Tx SC settings autofilled\n    \n        ####################\n        # Traffic\n        ####################\n        # Gratuitous ARP is sent so that DUT can learn our IP. Grat ARP source/destination are local address\n        # DUT MAC needs to be configured manually stateless encyption only engine cannot decrypt any packet including DUT ARP\n        ip1.address = \"10.1.1.1\"\n        ip2.address = \"10.1.1.2\"\n        ip3.address = \"10.1.1.3\"\n        ip4.address = \"10.1.1.4\"\n    \n        ip1.prefix = ip2.prefix = ip3.prefix = ip4.prefix =24\n    \n        ip1.gateway = ip2.address\n        ip2.gateway = ip1.address\n    \n        ip3.gateway = ip4.address\n        ip4.gateway = ip3.address\n    \n        ip1.gateway_mac.choice = \"value\"\n        ip1.gateway_mac.value = eth2.mac\n    \n        ip2.gateway_mac.choice = \"value\"\n        ip2.gateway_mac.value = eth1.mac\n    \n        ip3.gateway_mac.choice = \"value\"\n        ip3.gateway_mac.value = eth4.mac\n    \n        ip4.gateway_mac.choice = \"value\"\n        ip4.gateway_mac.value = eth3.mac\n    \n        # Flows\n        f1 = config.flows.flow(name=\"f1\")[-1]\n        f2 = config.flows.flow(name=\"f2\")[-1]\n    \n        # IP\n        f1.packet.ethernet().macsec().ipv4()\n        f2.packet.ethernet().macsec().ipv4()\n    \n        # DSCP\n        f1_ip = f1.packet[-1]\n        f2_ip = f2.packet[-1]\n    \n        f1_ip.priority.choice = f1_ip.priority.DSCP\n        f1_ip.priority.dscp.phb.values = [\n        f1_ip.priority.dscp.phb.CS2,\n        f1_ip.priority.dscp.phb.CS1,\n        f1_ip.priority.dscp.phb.CS5,\n        ]\n    \n        f2_ip.priority.choice = f2_ip.priority.DSCP\n        f2_ip.priority.dscp.phb.values = [\n        f2_ip.priority.dscp.phb.CS2,\n        f2_ip.priority.dscp.phb.CS1,\n        f2_ip.priority.dscp.phb.CS5,\n        ]\n    \n        f1_ip.priority.dscp.ecn.value = 3\n        f2_ip.priority.dscp.ecn.value = 3\n    \n        # IPv4 traffic from IP to IP endpoints\n        f1.tx_rx.device.tx_names = [ip1.name]\n        f2.tx_rx.device.tx_names = [ip3.name]\n    \n        f1.tx_rx.device.rx_names = [ip2.name]\n        f2.tx_rx.device.rx_names = [ip4.name]\n    \n        # Rate\n        f1.rate.pps = 5\n        f2.rate.pps = 5\n    \n        utils.start_traffic(api, config)\n    \n        ####################\n        # MKA stats\n        ####################\n        utils.wait_for(\n            lambda: results_mka_ok(api), \"stats to be as expected\", timeout_seconds=20\n        )\n        enums = [\n            \"mkpdu_tx\",\n            \"mkpdu_rx\",\n            \"live_peer_count\",\n            \"potential_peer_count\",\n            \"latest_key_tx_peer_count\",\n            \"latest_key_rx_peer_count\",\n            \"malformed_mkpdu\",\n            \"icv_mismatch\",\n        ]\n        expected_results = {\n            \"enc_only_macsec1\": [0, 0, 0, 0, 0, 0, 0, 0],\n            \"enc_only_macsec2\": [0, 0, 0, 0, 0, 0, 0, 0],\n        }\n        req = api.metrics_request()\n        req.mka.peer_names = [\"enc_only_macsec1\"]\n        results = api.get_metrics(req)\n        assert len(results.mka_metrics) == 1\n        assert results.mka_metrics[0].name == \"enc_only_macsec1\"\n        print(f\"\\n\\nMKA Result : enc_only_macsec1\\n\")\n        for mka_res in results.mka_metrics:\n            for i, enum in enumerate(enums):\n                val = expected_results[mka_res.name][i]\n                if \"session_state\" in enum:\n                    assert getattr(mka_res, enum) == val\n                else:\n                    assert getattr(mka_res, enum) >= val\n                print(f\"{enum} : {getattr(mka_res, enum)}\")\n    \n        req = api.metrics_request()\n        req.mka.peer_names = [\"enc_only_macsec2\"]\n        results = api.get_metrics(req)\n        assert len(results.mka_metrics) == 1\n        assert results.mka_metrics[0].name == \"enc_only_macsec2\"\n        print(f\"\\n\\nMKA Result : enc_only_macsec2\")\n        for mka_res in results.mka_metrics:\n            for i, enum in enumerate(enums):\n                val = expected_results[mka_res.name][i]\n                if \"session_state\" in enum:\n                    assert getattr(mka_res, enum) == val\n                else:\n                    assert getattr(mka_res, enum) >= val\n                print(f\"{enum} : {getattr(mka_res, enum)}\")\n    \n    \n        ####################\n        # MACsec stats\n        ####################\n        utils.wait_for(\n            lambda: results_macsec_ok(api), \"stats to be as expected\", timeout_seconds=30\n        )\n    \n        enums = [\n            \"session_state\",\n            \"out_pkts_protected\",\n            \"out_pkts_encrypted\",\n            \"in_pkts_ok\",\n            \"in_pkts_bad\",\n            \"in_pkts_bad_tag\",\n            \"in_pkts_late\",\n            \"in_pkts_no_sci\",\n            \"in_pkts_not_using_sa\",\n            \"in_pkts_not_valid\",\n            \"in_pkts_unknown_sci\",\n            \"in_pkts_unused_sa\",\n            \"in_pkts_invalid\",\n            \"in_pkts_untagged\",\n            \"out_octets_protected\",\n            \"out_octets_encrypted\",\n            \"in_octets_validated\",\n            \"in_octets_decrypted\",\n        ]\n        expected_results = {\n            \"enc_only_macsec1\": [\"up\", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n            \"enc_only_macsec2\": [\"up\", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n        }\n        req = api.metrics_request()\n        req.macsec.secure_entity_names = [\"enc_only_macsec1\"]\n        results = api.get_metrics(req)\n>       assert len(results.macsec_metrics) == 1\nE       assert 2 == 1\nE        +  where 2 = len(<snappi.snappi.MacsecMetricIter object at 0x7f7de64dc6c0>)\nE        +    where <snappi.snappi.MacsecMetricIter object at 0x7f7de64dc6c0> = <snappi.snappi.MetricsResponse object at 0x7f7de6397e20>.macsec_metrics\n\ntests/macsec/test_macsec_mka_multiple_devices.py:290: AssertionError","flaky":true,"newFailed":true,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[],"testStage":{"steps":[{"name":"--------------------------------- Captured Log ---------------------------------","time":{},"steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"","time":{},"steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"--------------------------------- Captured Out ---------------------------------","time":{},"steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":3,"attachmentsCount":0,"hasContent":true,"attachmentStep":false},"afterStages":[],"labels":[{"name":"resultFormat","value":"junit"},{"name":"suite","value":"pytest"},{"name":"host","value":"snappi-ixn-ci-novus10g"},{"name":"testClass","value":"macsec.test_macsec_mka_multiple_devices"},{"name":"package","value":"macsec.test_macsec_mka_multiple_devices"}],"parameters":[],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[],"flaky":false}],"history":{"statistic":{"failed":44,"broken":0,"skipped":1,"passed":82,"unknown":0,"total":127},"items":[{"uid":"cbac0b8ec7cfd81b","status":"passed","time":{"start":1756097345515,"stop":1756097473644,"duration":128129}},{"uid":"ce6cb2582e0a2f87","status":"passed","time":{"start":1755853618770,"stop":1755853736050,"duration":117280}},{"uid":"cab0671ebb33a936","status":"passed","time":{"start":1755770830114,"stop":1755770958289,"duration":128175}},{"uid":"3848ad17560b444","status":"passed","time":{"start":1755605594608,"stop":1755605714806,"duration":120198}},{"uid":"6aaa488fb0d0b9a","status":"failed","statusDetails":"assert 2 == 1\n +  where 2 = len(<snappi.snappi.MacsecMetricIter object at 0x7ffb38503080>)\n +    where <snappi.snappi.MacsecMetricIter object at 0x7ffb38503080> = <snappi.snappi.MetricsResponse object at 0x7ffb378372e0>.macsec_metrics","time":{"start":1755598268759,"stop":1755598376078,"duration":107319}},{"uid":"3c555c4843e7f34e","status":"passed","time":{"start":1755590656281,"stop":1755590791235,"duration":134954}},{"uid":"6270974d7a61336","status":"passed","time":{"start":1755582190551,"stop":1755582322113,"duration":131562}},{"uid":"583c2576b21cbec3","status":"passed","time":{"start":1755172446673,"stop":1755172565423,"duration":118750}},{"uid":"b5d048cdfc555bcd","status":"passed","time":{"start":1755152544019,"stop":1755152671890,"duration":127871}},{"uid":"801ac0f87ab5f30d","status":"passed","time":{"start":1754658965828,"stop":1754659096305,"duration":130477}},{"uid":"fdf203f917604e2a","status":"passed","time":{"start":1754630978584,"stop":1754631105424,"duration":126840}},{"uid":"19cda5246282c0e2","status":"passed","time":{"start":1754558943969,"stop":1754559073167,"duration":129198}},{"uid":"f95e690806e4dc78","status":"failed","statusDetails":"assert 2 == 1\n +  where 2 = len(<snappi.snappi.MacsecMetricIter object at 0x7fa9bb365840>)\n +    where <snappi.snappi.MacsecMetricIter object at 0x7fa9bb365840> = <snappi.snappi.MetricsResponse object at 0x7fa9bb1ca750>.macsec_metrics","time":{"start":1754546458930,"stop":1754546572347,"duration":113417}},{"uid":"ab90b37c16c97ad4","status":"passed","time":{"start":1754506043870,"stop":1754506181127,"duration":137257}},{"uid":"622a43382a8eef3","status":"passed","time":{"start":1754497549774,"stop":1754497682669,"duration":132895}},{"uid":"56690797e9af012a","status":"passed","time":{"start":1754464142327,"stop":1754464271588,"duration":129261}},{"uid":"a85d353760ad3b30","status":"failed","statusDetails":"assert 2 == 1\n +  where 2 = len(<snappi.snappi.MkaMetricIter object at 0x7fa71713a1c0>)\n +    where <snappi.snappi.MkaMetricIter object at 0x7fa71713a1c0> = <snappi.snappi.MetricsResponse object at 0x7fa717199300>.mka_metrics","time":{"start":1754456730779,"stop":1754456835974,"duration":105195}},{"uid":"22e816fdda668837","status":"passed","time":{"start":1754377059323,"stop":1754377193471,"duration":134148}},{"uid":"8199142c7fccfcda","status":"passed","time":{"start":1754345071017,"stop":1754345206588,"duration":135571}},{"uid":"1b2bff5eb3b69b6c","status":"passed","time":{"start":1754337190110,"stop":1754337328699,"duration":138589}}]},"tags":[]},"source":"f6b2d17be5449edf.json","parameterValues":[]}